services:
  pgbouncer-dev:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Mount source code read-only
      - ..:/src:ro
      # Build output volume (keeps source clean)
      - build-output:/build
      # Mount source directories read-only
      - ../src:/build/src:ro
      - ../lib:/build/lib:ro
      - ../include:/build/include:ro
      - ../etc:/build/etc:ro
      - ../doc:/build/doc:ro
      - ../pyproject.toml:/build/pyproject.toml:ro
      # Test directory needs read-write (creates certs, temp files)
      - ../test:/build/test
    # Keep container running for interactive use
    stdin_open: true
    tty: true
    # Run as non-root user
    user: user
    working_dir: /build
    environment:
      - PGVERSION=16
      - CONCURRENCY=4
    # Default command keeps container alive
    command: ["bash"]

volumes:
  build-output:
