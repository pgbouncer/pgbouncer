services:
  pgbouncer-dev:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      # Mount source code read-only
      - ..:/source:ro
      # Build output volume (keeps source clean)
      - build-output:/build
      # Test directory needs read-write (creates certs, temp files)
      - ../test:/build/test
    # Keep container running for interactive use
    stdin_open: true
    tty: true
    # Run as non-root user
    user: user
    working_dir: /build
    environment:
      - PGVERSION=16
      - CONCURRENCY=4
    # Network capability for tc/iptables tests
    cap_add:
      - NET_ADMIN
    # Default command keeps container alive
    command: ["bash"]

volumes:
  build-output:
